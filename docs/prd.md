# 元标记精灵 (MetaTag Genie) 产品需求文档 (PRD)

## 引言

元标记精灵 (MetaTag Genie) 是一款 macOS 工具，旨在解决仅通过文件名管理和搜索本地图片库效率低下的问题。许多用户在没有丰富描述性元数据的情况下，难以定位特定图片。此 MVP (最小可行产品) 版本将提供一个核心服务（一个遵循 Model Context Protocol (MCP) 规范，并通过 Stdio 传输进行通信的服务），允许用户将结构化元数据——包括标签、描述、人物名称和地点信息——直接写入图片文件。这将显著增强通过 macOS Spotlight 搜索发现图片的体验。长远愿景包括与像 Cursor 这样的 AI 开发代理集成，以实现智能元数据建议，并提升跨设备搜索体验，初步验证目标是iPhone上的描述字段可搜索性。

## 目标与背景

-   **项目目标:**
    1.  开发一个 macOS 工具/服务，用于将指定的元数据（标签、描述、人物、地点）写入图片文件，该服务需符合 MCP (Model Context Protocol) 规范并通过 Stdio 传输与客户端通信。
    2.  确保元数据被写入标准字段（EXIF, IPTC, XMP）以保证兼容性。
    3.  验证添加了元数据的图片可以通过 macOS Spotlight 使用至少三种不同的元数据类型进行搜索。
    4.  使用 TypeScript 开发核心工具，并遵循测试驱动开发 (TDD) 原则。
-   **可衡量的成果:**
    1.  对于支持的图片格式（JPG, PNG, HEIC），所有指定类型的元数据写入操作成功率达到 95% 以上。
    2.  由本工具写入的所有元数据字段，均能通过标准元数据查看工具（如 ExifTool）正确读取和显示。
    3.  超过 90% 的已添加新元数据的测试图片，应能在 5 秒内通过 Spotlight 搜索找到。
    4.  (延伸目标) 工具写入的“描述”元数据，在图片导入 iPhone 照片应用后，能够被正确显示。
-   **成功标准:**
    1.  MCP 服务成功通过 Stdio 接收指令，并向 JPG, PNG, 和 HEIC 文件写入和读取标签、描述、人物（作为关键词）和地点文本的元数据。
    2.  Spotlight 搜索能根据新添加的元数据字段成功检索图片。
    3.  MCP 服务为元数据操作提供符合 JSON-RPC 规范的清晰反馈（成功/失败）通过 Stdio。
    4.  核心功能由自动化测试覆盖（目标覆盖率 80%）。
-   **关键绩效指标 (KPIs):**
    1.  元数据写入成功率 (目标: >95%)。
    2.  Spotlight 搜索检索准确率 (目标: >90%)。
    3.  Spotlight 搜索速度 (目标: <5 秒检索)。
    4.  测试覆盖率 (目标: 80%)。

## 范围与需求 (MVP / 当前版本)

### 功能性需求 (高层级)

1.  **MCP 服务实现:**
    * 实现一个符合 MCP 规范的服务器，通过 Stdio (标准输入/输出) 与客户端（如 AI 代理）进行通信。
    * 支持 MCP 初始化握手流程。
    * 消息交换遵循 JSON-RPC 2.0 规范。
2.  **元数据写入 Tool (`writeImageMetadata`):**
    * 在 MCP 服务中暴露一个名为 `writeImageMetadata` (或类似名称) 的 Tool。
    * 该 Tool 接受图片文件路径和结构化元数据（标签、描述、人物名称、地点文本）作为参数。
3.  **图片格式支持:** 该 Tool 必须支持读取和写入以下图片格式的元数据：
    * JPEG (.jpg, .jpeg)
    * PNG (.png)
    * HEIC (.heic) - (高效率图像编码)
4.  **元数据字段处理:**
    * `标签/关键词 (Tags/Keywords)`: 写入合适的 IPTC/XMP 字段 (例如, IPTC Keywords, XMP dc:subject)。
    * `描述 (Description)`: 写入合适的 IPTC/XMP 字段 (例如, EXIF ImageDescription, IPTC Caption-Abstract, XMP dc:description)。
    * `人物 (People)`: 作为独立关键词写入与标签/关键词相同的字段。
    * `地点 (Location)`: 文本型地点描述写入一个合适的 XMP 字段（具体字段待架构师研究确定，优先考虑 Spotlight 索引效率）。
    * 确保未明确修改的现有元数据得以保留。
    * 选项：覆盖或追加元数据（默认为覆盖）。
5.  **输出/反馈 (通过 Stdio):**
    * Tool 执行结果（成功或错误）通过符合 JSON-RPC 2.0 规范的消息返回给客户端。
    * 错误信息应包含有意义的错误码和描述。
    * 成功信息应确认操作完成。
6.  **Spotlight 索引启用:** 确保写入的元数据存储在能被 macOS Spotlight 有效索引的字段和格式中。

### 非功能性需求 (NFRs)

-   **性能:**
    * 通过 MCP Tool 进行单个图片的元数据写入操作应在 1-2 秒内完成响应（不包括 AI 代理的处理时间）。
    * Spotlight 索引延迟取决于 macOS，测试应验证索引通常在合理时间内发生。
-   **可靠性/可用性:**
    * MCP 服务在处理请求时应稳定可靠，元数据写入操作具有高可靠性，最大限度降低文件损坏风险。
    * 稳健的错误处理机制。
-   **安全性:**
    * 工具操作本地文件，由调用者指定路径。无外部网络数据传输（除 MCP 协议本身通过 Stdio）。
    * MVP 无需用户认证。
-   **可维护性:**
    * 代码必须有良好文档，特别是 MCP Tool 的定义、参数、元数据字段映射和库交互部分。
    * 遵循 TDD 原则。
-   **易用性/可访问性 (针对 MCP 服务调用者):**
    * MCP Tool 的定义 (名称、参数、返回值) 应清晰、易于理解和集成。
    * JSON-RPC 消息结构应标准、一致。
-   **其他约束:**
    * **技术栈:** TypeScript。
    * **开发流程:** TDD。
    * **目标平台 (MVP):** macOS (最新的两个主要版本)。
    * **数据存储:** 元数据直接写入图片文件。无外部数据库。
    * **MCP 遵从性:** 严格遵循 Model Context Protocol 规范实现服务和 Tool。

### 用户体验 (UX) 需求 (高层级)

-   作为后端服务，其“用户体验”主要关系到调用者（如 AI 代理）与 MCP 服务交互的体验。
-   **MCP 服务 (Stdio 模式)**：
    -   通过 Stdio 传输的 JSON-RPC 消息，其请求和响应结构应逻辑清晰。
    -   Tool 的定义（参数、功能）应清晰易懂。
    -   错误状态和成功反馈应明确无歧义。

### 集成需求 (高层级)

-   **AI 开发代理 (例如 Cursor):** MCP 服务通过 Stdio 被此类客户端调用。
-   **macOS Spotlight:** 核心集成点，确保写入的元数据可被 Spotlight 搜索。

### 测试需求 (高层级)

-   全面的单元测试覆盖核心逻辑（元数据处理、MCP Tool 实现）。
-   集成测试验证 MCP 服务通过 Stdio 的交互、Tool 调用、元数据实际写入和读取 (使用 ExifTool 等)。
-   端到端测试模拟 AI 代理调用 MCP 服务并验证 Spotlight 搜索结果。
-   目标 80% 代码覆盖率。

## Epic 概览 (MVP / 当前版本)

-   **Epic 1: 核心元数据引擎和符合 MCP 规范的基础服务外壳 (Stdio 传输)** - 目标: 建立项目的基础结构，包括 TypeScript 项目设置、TDD 环境配置、核心元数据处理库的选型与集成。实现一个基础的、符合 MCP 规范的服务器外壳（使用 Stdio 传输），并完成针对单一图片格式（例如 JPG）的单一元数据类型（例如标签）的基本写入与读取功能，作为 MCP 的一个 Tool。
-   **Epic 2: 扩展图片格式和元数据类型支持** - 目标: 扩展功能以支持所有 MVP 图片格式 (PNG, HEIC) 和所有元数据类型 (描述, 人物名称作为关键词, 地点文本)，并作为 MCP Tool 的参数或独立 Tool 暴露。包括研究并确定每种元数据类型到标准 EXIF/IPTC/XMP 字段的最佳映射方案。
-   **Epic 3: Spotlight 集成、错误处理和 MCP 服务反馈** - 目标: 确保通过 MCP Tool 写入的元数据能够被 macOS Spotlight 有效索引和搜索。同时，实现全面的错误处理机制和清晰的 MCP 服务反馈机制（通过 Stdio 上的 JSON-RPC），以提升工具的健壮性和易用性。
-   **Epic 4: 文档和最终完善** - 目标: 完成所有必要的项目文档，包括用户指南 (README)、MCP 服务及其 Tools 的定义文档。对 MCP 服务接口进行健壮性打磨，执行全面的端到端测试，修复发现的缺陷，并为 MVP 版本进行最终的准备。

## 关键参考文件

-   `docs/project-brief.md` (项目简章)
-   `docs/architecture.md` (架构文档，由架构师创建)
-   `docs/epic1.md`, `docs/epic2.md`, `docs/epic3.md`, `docs/epic4.md` (Epic 文档)
-   `docs/tech-stack.md` (技术栈文档，由架构师创建)
-   `docs/mcp-tools-definition.md` (MCP Tools 定义文档，替代传统 API 参考)
-   `docs/testing-strategy.md` (测试策略文档，待创建)

## Post-MVP / Future Enhancements

-   支持更复杂的 MCP 能力，如 Resources (例如，允许 AI 代理请求图片缩略图或部分元数据)。
-   GUI 应用版本。
-   支持更多元数据字段和图片/文件格式。
-   批量处理功能。
-   高级“人物”元数据：探索写入特定的 XMP 人脸区域标签。
-   云同步分析。
-   提供配置选项。

## 变更日志

| 变更内容      | 日期       | 版本  | 描述                                     | 作者        |
| ------------- | ---------- | ----- | ---------------------------------------- | ----------- |
| 初稿          | 2025-05-06 | 0.1   | PRD 初稿 (基于 CLI 或 MCP HTTP 服务选项)     | 2-PM (产品经理) |
| 重大修订      | 2025-05-06 | 0.2   | 明确 MVP 为 MCP 服务，指定 Stdio 传输，并全面更新 | 2-PM (产品经理) |

## 给架构师的初始提示

### 技术基础设施

-   **启动项目/模板:** 不强制使用特定的启动模板。架构师应建立一个清晰的 TypeScript 项目结构。
-   **托管/云提供商:** MVP 不适用 (本地 Stdio 服务)。
-   **前端平台:** MVP 不适用。
-   **后端平台:** Node.js 与 TypeScript 是必需的。由于将实现一个通过 **Stdio 传输**的 Model Context Protocol (MCP) 服务，架构师应调研并选择合适的 Node.js/TypeScript 库或方法来实现 MCP 规范，特别是其 Stdio 传输机制、JSON-RPC 2.0 消息处理以及 Tool 的定义和注册。
-   **数据库需求:** MVP 无外部数据库。

### 技术约束

-   **强制语言:** TypeScript。
-   **强制开发流程:** Test-Driven Development (TDD)。
-   **目标平台 (MVP):** macOS (最新的两个主要版本)。
-   **元数据库:** 架构师应研究并推荐适用于读写 EXIF, IPTC, 和 XMP 元数据的 TypeScript 兼容库 (例如 `exiftool-vendored` 等)。重点考虑 HEIC 支持、可靠性、维护状态。
-   **Spotlight 兼容性:** 元数据字段映射必须优先考虑与 macOS Spotlight 索引的兼容性。
-   **文件处理:** 稳健的文件 I/O。
-   **MCP 规范遵从:** 严格遵循 MCP 规范，特别是关于 Stdio 传输、JSON-RPC 2.0 和 Tool 定义的部分。

### 部署考虑

-   **MCP 服务 (Stdio):** 由于采用 Stdio 传输，部署上主要是确保可执行脚本或应用的正确分发和调用。AI 代理（如 Cursor）将直接通过标准输入/输出与该进程交互，管理其生命周期。

### 本地开发与测试需求

-   易于在 macOS 上进行本地开发设置。
-   提供构建、运行测试（单元、集成、模拟 MCP 客户端的端到端 Spotlight 测试）和代码检查的脚本。
-   准备多样化的测试图片集。
-   方便检查图片元数据的工具。

### 其他技术考虑

-   **错误处理:** MCP Tool 的错误必须以符合 JSON-RPC 2.0 错误对象规范的格式通过 Stdio 返回。
-   **模块化:** 清晰分离 MCP 协议处理、Tool 业务逻辑和元数据操作。
-   **性能:** 元数据操作应高效。
-   **“人物”作为关键词:** MVP 策略。
-   **“地点”文本字段研究:** 架构师需确定最佳字段并记录。
-   **字符编码:** 确保 UTF-8。
-   **MCP Stdio 传输实现**: 重点关注如何稳健地通过 Stdio 实现 JSON-RPC 2.0 的消息收发、错误处理，以及与 AI 代理的生命周期管理（例如，代理如何启动和终止此 MCP 服务进程）。确保与 MCP 客户端的兼容性。
-   **MCP Tool 设计**: `writeImageMetadata` (或其他命名的 Tool) 的参数设计应清晰、结构化 (建议使用 JSON Schema 定义)，便于 AI 代理调用。考虑 Tool 的幂等性（如果适用）。