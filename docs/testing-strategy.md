# MetaTag Genie 测试策略

## 整体理念与目标

本项目的测试策略遵循测试驱动开发 (TDD) 原则，旨在确保 MetaTag Genie 服务的健壮性、可靠性和正确性。我们将努力实现高代码覆盖率（目标 80%），并通过自动化测试预防功能退化，增强重构信心。测试将覆盖从单个函数到元数据正确写入文件的完整流程。

* **目标 1:** 核心功能（元数据写入、MCP Tool 交互）的代码覆盖率达到或超过 80%。
* **目标 2:** 确保所有支持的图片格式 (JPG, PNG, HEIC) 和元数据类型都能按预期工作。
* **目标 3:** 验证写入的元数据能被 macOS Spotlight 有效索引和搜索（通过辅助方法验证）。
* **目标 4:** 确保 MCP 服务接口的稳定性和对各种输入的正确响应（包括错误处理）。
* **目标 5:** 测试执行应高效，并能集成到 CI/CD 流程中。

## 测试层级

### 单元测试 (Unit Tests)

* **范围:** 测试项目中最小的可测试单元，如单个函数、方法或模块。重点测试：
    * `core/metadata-writer.ts` 中的元数据字段映射逻辑、与 `exiftool-vendored` 的参数构造和结果解析。
    * `src/common/` 下的工具函数。
    * `mcp/tools/writeImageMetadata.ts` 中参数校验、对 `metadata-writer` 的调用逻辑。
    * 独立模块的内部逻辑和边界条件。
* **工具:** Jest。
* **Mocking/Stubbing:**
    * 使用 Jest 的 `jest.mock()` 和 `jest.spyOn()` 来 mock 依赖，例如：
        * Mock `exiftool-vendored` 模块以模拟其行为（成功、失败、不同输出），避免实际文件 I/O 和 ExifTool 进程调用。
        * Mock Node.js `fs` 模块。
        * Mock `@modelcontextprotocol/sdk` 的部分功能（如果需要测试 MCP 服务逻辑的特定部分而不启动完整服务器）。
* **位置:** `tests/unit/` 目录，文件命名通常为 `[module-name].test.ts`，目录结构镜像 `src/`。
* **期望:**
    * 覆盖所有关键逻辑路径、条件分支和错误处理。
    * 执行速度快，适合在开发过程中频繁运行。
    * 为 TDD 提供基础。

### 集成测试 (Integration Tests)

* **范围:** 验证项目中多个模块之间的交互是否按预期工作。重点测试：
    * MCP 服务 (`mcp/server.ts`) 与 `writeImageMetadata` Tool (`mcp/tools/writeImageMetadata.ts`) 的集成，确保 Tool 能被正确注册和调用。
    * `writeImageMetadata` Tool 与 `core/metadata-writer.ts` 的集成，确保参数传递和元数据写入请求能正确流转。
    * 模拟 MCP 客户端通过 `@modelcontextprotocol/sdk`（或其 Stdio 传输部分）与本地运行的 MCP 服务实例进行完整的 JSON-RPC 交互（初始化、Tool 调用、成功/错误响应）。
    * 在受控环境下，`metadata-writer.ts` 与真实的（或精心准备的测试替身）`exiftool-vendored` 实例对测试图片文件进行实际的元数据读写操作，验证文件是否按预期被修改。
* **工具:** Jest (用于编排和断言), 可能结合一些辅助脚本或测试图片。
* **Mocking/Stubbing:**
    * 尽量减少 Mock，关注模块间的真实交互。
    * 对于真正的文件操作，会使用临时目录和预设的测试图片。
    * 外部依赖（如 Spotlight）在此阶段不直接测试，而是验证文件元数据是否正确写入。
* **位置:** `tests/integration/` 目录。
* **期望:**
    * 确保模块间的契约得到遵守。
    * 覆盖关键的交互流程。
    * 执行速度慢于单元测试，但在 CI 中仍应能接受。

### 端到端测试 (End-to-End / E2E Tests)

* **范围:** 模拟一个完整的用户场景，从客户端（例如一个模拟的 AI 代理或测试脚本）通过 Stdio 调用 MCP 服务，到实际写入元数据。**此阶段的主要验证目标是元数据是否已按照预期的字段和格式正确写入图片文件。** 这将通过在测试脚本中回读并验证被修改文件的元数据来实现。
    * **场景 1 (核心功能验证):** 调用 `writeImageMetadata` Tool 为不同格式的图片 (JPG, PNG, HEIC) 添加所有类型的元数据 (标签, 描述, 人物, 地点)。然后，通过程序化方式（例如，调用 `core/metadata-writer.ts` 的读取功能或直接使用 `exiftool-vendored`）读取图片元数据，并断言其与写入的元数据一致。
    * **场景 2 (错误处理):** 发送无效参数、操作不存在的文件、操作无权限文件等，验证 MCP 服务是否返回符合规范的 JSON-RPC 错误。
* **工具:**
    * 自定义 Node.js/TypeScript 测试脚本 (使用 `child_process` 模块启动 MetaTag Genie 服务进程，并通过其 `stdin`/`stdout` 发送和接收 JSON-RPC 消息)。
    * Jest 用于组织测试用例和断言。
    * `exiftool-vendored` (或项目中封装的读取函数) 用于在测试中断言写入后图片的实际元数据。
* **环境:** 必须在 macOS 环境下运行。测试需要有权限创建临时图片文件。
* **位置:** `tests/e2e/` 目录。
* **期望:**
    * 验证整个系统核心功能（元数据写入）是否符合 PRD 要求。
    * 覆盖最关键的用户旅程和错误处理路径。
    * 执行速度可能慢于集成测试，但应足够稳定以便在 CI 中运行。

## Spotlight 验证方法

PRD 中要求验证通过本工具写入的元数据能被 macOS Spotlight 搜索到。鉴于直接在自动化 E2E 测试中依赖 Spotlight 索引的即时性和稳定性存在挑战（耗时且结果可能不确定），我们将采用以下组合方法进行验证：

1.  **元数据写入正确性 (自动化测试核心):** 如上所述，E2E 测试将严格验证元数据是否已正确、完整地写入图片文件的标准字段中。这是 Spotlight 能够索引的前提。
2.  **手动/探索性测试 (辅助验证):**
    * 在开发阶段和版本发布前，由测试人员在真实的 macOS 环境中进行手动的 Spotlight 搜索测试。
    * 测试人员将使用各种元数据组合（标签、描述中的词语、人物名称、地点文本）来搜索已通过工具处理的图片。
    * 记录搜索的成功率、准确性和大致的响应时间。
    * 此手动测试将覆盖 PRD 中关于 Spotlight 搜索速度和准确率的 KPI。
3.  **(可选) 辅助验证脚本:** 可以开发一个独立的辅助脚本（非 CI 阻塞），该脚本在写入元数据后，尝试使用 `mdfind` 命令在一段时间后查询 Spotlight。此脚本的结果更多地作为一种指示性或调试辅助工具，而非严格的自动化测试通过/失败标准。

通过这种方式，我们既能确保应用核心功能的自动化测试质量，又能通过更合适的方法满足 PRD 对 Spotlight 集成效果的验证要求。

## 测试数据管理

* **单元测试:** 主要使用 mock 数据和内联值。
* **集成测试/端到端测试:**
    * 提供一小组预定义的测试图片 (JPG, PNG, HEIC)，包含不同的初始元数据状态（无元数据、部分元数据等）。这些图片应存放在 `tests/fixtures/images` 目录。
    * 测试过程中，会将这些图片复制到临时目录进行操作，以避免修改原始测试样本。
    * 测试完成后清理临时文件。

## CI/CD 集成

* 所有类型的自动化测试 (单元、集成、端到端) 都应集成到 CI/CD 流程中 (例如，通过 GitHub Actions)。
* **代码推送/PR 时:** 自动运行所有单元测试和集成测试。测试失败会阻止合并。
* **预发布/特定分支合并到主干时:** 自动运行所有测试，包括端到端测试（验证元数据写入）。测试失败会阻止发布。
* 代码覆盖率报告 (例如由 Jest 生成) 应在 CI 中收集，并可用于评估是否达到 80% 的目标。
* Linting 和代码格式化检查也应在 CI 中执行。

## 特殊考虑 (MVP)

* **HEIC 支持:** 由于 HEIC 是一个关键格式且元数据处理可能更复杂，各层级测试应特别关注 HEIC 文件的元数据读写。
* **`exiftool-vendored` 的行为:** 测试应覆盖 `exiftool-vendored` 可能出现的各种情况，包括成功执行、错误返回、超时等。
* **文件操作的健壮性:** 测试应覆盖各种文件系统相关的边界情况，如路径问题、权限问题（在可控范围内模拟）。

## 变更日志

| 变更内容      | 日期       | 版本  | 描述                                                     | 作者        |
| ------------- | ---------- | ----- | -------------------------------------------------------- | ----------- |
| 初稿          | 2025-05-07 | 0.1   | 基于模板和项目需求创建                                      | 3-Architect |
| 修订          | 2025-05-07 | 0.2   | 调整 E2E 测试范围，明确 Spotlight 验证方法以处理索引延迟问题 | 3-Architect |

---